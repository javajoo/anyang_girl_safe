<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

    
<mapper namespace="girlSafe">
	<select id="getUserList" parameterType="map" resultType="HashMap">
		<![CDATA[		
	       SELECT 
				@ROWNUM := @ROWNUM + 1 AS num,
				a.ENCRYPT_NAME as name,
				a.AGE as age,
				a.PHONE_NUMBER as phoneNumber,
				a.ENCRYPT_ADRES as address,
				CASE a.APPROVAL
					WHEN 'N' THEN '비승인'
					WHEN 'Y' THEN '승인'
				END as approval,
				b.SMART_ID as smartId,
				b.SENSOR_ID as sensorId,				
				CASE b.STATUS
					WHEN '0' THEN 'ON'
					WHEN '1' THEN 'OFF'
				END as status,
				b.STATUS as chkStatus,
				CASE b.BAT
					WHEN '0' THEN '정상(대)'
					WHEN '1' THEN '정상(중)'
					WHEN '2' THEN '교체필요'
				END as bat,
				b.BAT as chkBat,
				b.EMERGENCY as emergency,
				b.POINT_X as pointX,
				b.POINT_Y as pointY,
				b.M_POINT_X as mPointX,
				b.M_POINT_Y as mPointY,
				date_format(a.INSERT_DATE,'%Y-%m-%d %H:%i:%s')as insertDate,
				date_format(a.UPDATE_DATE,'%Y-%m-%d %H:%i:%s') as updateDate,
				c.S_PHONE_NUMBER as sPhoneNumber
			FROM girl_safe_user a
	        JOIN girl_safe_hw b on a.PHONE_NUMBER = b.PHONE_NUMBER
	        LEFT JOIN girl_safe_user_sub c ON a.PHONE_NUMBER = c.PHONE_NUMBER
	        ,(SELECT @ROWNUM := #{firstIndex}) R 
	        WHERE 1=1
	     ]]> 
	    <if test="approval != null and approval != ''">
	    	AND a.APPROVAL = #{approval}
	    </if>
	    <if test="batStatus != null and batStatus != ''">
	    	AND b.BAT = #{batStatus}
	    </if>
	    <if test="hwStatus != null and hwStatus != ''">
	    	AND b.STATUS = #{hwStatus}
	    </if>
	    <if test="userTimeS != null and userTimeS != ''">
	    <![CDATA[
	    	AND a.INSERT_DATE >= #{userTimeS}
	    ]]> 
	    </if>
	    <if test="userTimeE != null and userTimeE != ''">
	    <![CDATA[
	    	AND a.INSERT_DATE <= #{userTimeE}
	    ]]> 
	    </if>
	    <if test="lastTimeS != null and lastTimeS != ''">
	    <![CDATA[
	    	AND a.UPDATE_DATE >= #{lastTimeS}
	    ]]> 
	    </if>
	    <if test="lastTimeE != null and lastTimeE != ''">
	    <![CDATA[
	    	AND a.UPDATE_DATE <= #{lastTimeE}
	    ]]> 
	    </if>
		<if test="searchType != null and searchType != ''">
			<choose>
				<when test="searchType == 'sensor'">
				AND b.SENSOR_ID LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'name'">
				AND a.ENCRYPT_NAME LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'age'">
				AND a.AGE LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'adres'">
				AND a.ENCRYPT_ADRES LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'phon'">
				AND a.PHONE_NUMBER LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<otherwise>
				AND a.ENCRYPT_NAME LIKE CONCAT('%', #{totSearch}, '%')
				</otherwise>
			</choose>
		</if>
		<if test='recordCountPerPage != -1'>
			LIMIT #{firstIndex}, #{recordCountPerPage}
		</if> 
	</select>
	
	<select id="getUserListCnt" parameterType="map" resultType="String">
		<![CDATA[		
	         SELECT 
				COUNT(*)
			FROM girl_safe_user a
	        JOIN girl_safe_hw b on a.PHONE_NUMBER = b.PHONE_NUMBER
	        LEFT JOIN girl_safe_user_sub c ON a.PHONE_NUMBER = c.PHONE_NUMBER
	        WHERE 1=1
	     ]]> 
	    <if test="approval != null and approval != ''">
	    	AND a.APPROVAL = #{approval}
	    </if>
	    <if test="batStatus != null and batStatus != ''">
	    	AND b.BAT = #{batStatus}
	    </if>
	    <if test="hwStatus != null and hwStatus != ''">
	    	AND b.STATUS = #{hwStatus}
	    </if>
	    <if test="userTimeS != null and userTimeS != ''">
	    <![CDATA[
	    	AND a.INSERT_DATE >= #{userTimeS}
	    ]]> 
	    </if>
	    <if test="userTimeE != null and userTimeE != ''">
	    <![CDATA[
	    	AND a.INSERT_DATE <= #{userTimeE}
	    ]]> 
	    </if>
		<if test="searchType != null and searchType != ''">
			<choose>
				<when test="searchType == 'name'">
				AND a.ENCRYPT_NAME LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'age'">
				AND a.AGE LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'adres'">
				AND a.ENCRYPT_ADRES LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'phon'">
				AND a.PHONE_NUMBER LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<otherwise>
				AND a.ENCRYPT_NAME LIKE CONCAT('%', #{totSearch}, '%')
				</otherwise>
			</choose>
		</if>
   
	</select>
	
	<select id="getHwInfo" parameterType="map" resultType="HashMap">
	       SELECT 
				a.PHONE_NUMBER as phoneNumber,
				b.SMART_ID as smartId,
				b.SENSOR_ID as sensorId,
				b.EMERGENCY as emergency,
				b.POINT_X as pointX,
				b.POINT_Y as pointY,
				b.M_POINT_X as mPointX,
				b.M_POINT_Y as mPointY
			FROM girl_safe_user a
	        JOIN girl_safe_hw b on a.PHONE_NUMBER = b.PHONE_NUMBER
	        WHERE 1=1
        	AND b.SENSOR_ID = #{sensorId}
	</select>
	
	<update id="updateSensorStat" parameterType="map">
			UPDATE girl_safe_hw
			SET 
				STATUS=#{status},
				BAT=#{bat},
				<if test="pointX != null">
					POINT_Y=#{pointY},
					POINT_X=#{pointX},
				</if>
				UPDATE_DATE=NOW()
			WHERE SENSOR_ID=#{sensorId};
	</update>
	
	<update id="updateEmergency" parameterType="map">
			UPDATE girl_safe_hw
			SET 
				EMERGENCY=#{emergency},
				<if test="pointX != null">
					POINT_Y=#{pointY},
					POINT_X=#{pointX},
				</if>
				UPDATE_DATE=NOW()
			WHERE SENSOR_ID=#{sensorId};
	</update>
	
	<update id="updateApproval" parameterType="map">
			UPDATE girl_safe_user
			SET 
				APPROVAL='Y',
				UPDATE_DATE=NOW()
			WHERE PHONE_NUMBER=#{phoneNumber};
	</update>
	
	<select id="getEventList" parameterType="map" resultType="HashMap">
		<![CDATA[		
	       SELECT 
				@ROWNUM := @ROWNUM + 1 AS num,
				PHONE_NUMBER as phoneNumber,
				ENCRYPT_NAME as name,
				AGE as age,
				ENCRYPT_ADRES as address,
				SMART_ID as smartId,
				SENSOR_ID as sensorId,
				DIVISION as division,
				CASE END_YN
					WHEN 'N' THEN '발생'
					WHEN 'Y' THEN '종료'
				END as endYN,
				POINT_X as pointX,
				POINT_Y as pointY,
				date_format(START_TIME,'%Y-%m-%d %H:%i:%s') as startTime,
				date_format(END_TIME,'%Y-%m-%d %H:%i:%s') as endTime,
				date_format(INSERT_DATE,'%Y-%m-%d %H:%i:%s') as insertDate
				
			FROM girl_safe_event
	        ,(SELECT @ROWNUM := #{firstIndex}) R 
	        WHERE 1=1
	    ]]> 
	    <if test="endYN != null and endYN != ''">
	    	AND END_YN = #{endYN}
	    </if>
	    <if test="eventTimeS != null and eventTimeS != ''">
	    <![CDATA[
	    	AND INSERT_DATE >= #{eventTimeS}
	    ]]> 
	    </if>
	    <if test="eventTimeE != null and eventTimeE != ''">
	    <![CDATA[
	    	AND INSERT_DATE <= #{eventTimeE}
	    ]]> 
	    </if>
		<if test="searchType != null and searchType != ''">
			<choose>
				<when test="searchType == 'name'">
				AND ENCRYPT_NAME LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'age'">
				AND AGE LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'adres'">
				AND ENCRYPT_ADRES LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'phon'">
				AND PHONE_NUMBER LIKE CONCAT('%', #{totSearch}, '%')
				</when>
				<when test="searchType == 'sensor'">
				AND SENSOR_ID LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<otherwise>
				AND ENCRYPT_NAME LIKE CONCAT('%', #{totSearch}, '%')
				</otherwise>
			</choose>
		</if>
			ORDER BY INSERT_DATE DESC
		<if test='recordCountPerPage != -1'>
			LIMIT #{firstIndex}, #{recordCountPerPage}
		</if>
	</select>
	
	<select id="getEventListCnt" parameterType="map" resultType="String">
		<![CDATA[		
	       SELECT 
				COUNT(*)
			FROM girl_safe_event a
	        WHERE 1=1
	     ]]> 
	    <if test="endYN != null and endYN != ''">
	    	AND END_YN = #{endYN}
	    </if>
	    <if test="eventTimeS != null and eventTimeS != ''">
	    <![CDATA[
	    	AND INSERT_DATE >= #{eventTimeS}
	    ]]> 
	    </if>
	    <if test="eventTimeE != null and eventTimeE != ''">
	    <![CDATA[
	    	AND INSERT_DATE <= #{eventTimeE}
	    ]]> 
	    </if>
		<if test="searchType != null and searchType != ''">
			<choose>
				<when test="searchType == 'name'">
				AND ENCRYPT_NAME LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'age'">
				AND AGE LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'adres'">
				AND ENCRYPT_ADRES LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'phon'">
				AND PHONE_NUMBER LIKE CONCAT('%', #{totSearch}, '%')
				</when>
				<when test="searchType == 'sensor'">
				AND SENSOR_ID LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<otherwise>
				AND ENCRYPT_NAME LIKE CONCAT('%', #{totSearch}, '%')
				</otherwise>
			</choose>
		</if>
   
	</select>
	
	<update id="insertEvent" parameterType="map">
		INSERT INTO girl_safe_event
			(PHONE_NUMBER, ENCRYPT_NAME, AGE, ENCRYPT_ADRES, SENSOR_ID, SMART_ID, DIVISION, END_YN, POINT_X, POINT_Y, START_TIME, END_TIME, INSERT_DATE)
			SELECT 
				a.PHONE_NUMBER,
				a.ENCRYPT_NAME,
				a.AGE,
				a.ENCRYPT_ADRES,
				b.SENSOR_ID,
				b.SMART_ID,
				'SENSOR',
				'0',
				b.POINT_X,
				b.POINT_Y,
				NOW(),
				null,
				NOW()
			FROM girl_safe_user a
			JOIN girl_safe_hw b on a.PHONE_NUMBER = b.PHONE_NUMBER
			WHERE b.SENSOR_ID=#{sensorId};
	</update>
	
	<select id="getBoardList" parameterType="map" resultType="HashMap">
		<![CDATA[		
	       SELECT 
				@ROWNUM := @ROWNUM + 1 AS num,
				NO as no,
				TITLE as title,
				CONTENT as content,
				PUSH_YN as pushYN,
				COUNT as count,
				date_format(INSERT_DATE,'%Y-%m-%d')as insertDate,
				date_format(UPDATE_DATE,'%Y-%m-%d') as updateDate
	        FROM girl_safe_board,(SELECT @ROWNUM := #{firstIndex}) R 
	        WHERE 1=1
	    ]]> 
	    <if test="pushYN != null and pushYN != ''">
	    	AND PUSH_YN = #{pushYN}
	    </if>
	    <if test="boardInsertTimeS != null and boardInsertTimeS != ''">
	    <![CDATA[
	    	AND INSERT_DATE >= #{boardInsertTimeS}
	    ]]> 
	    </if>
	    <if test="boardInsertTimeE != null and boardInsertTimeE != ''">
	    <![CDATA[
	    	AND INSERT_DATE <= #{boardInsertTimeE}
	    ]]> 
	    </if>
		<if test="searchType != null and searchType != ''">
			<choose>
				<when test="searchType == 'title'">
				AND TITLE LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'cont'">
				AND CONTENT LIKE CONCAT('%', #{totSearch}, '%')
				</when>
				<otherwise>
				AND TITLE LIKE CONCAT('%', #{totSearch}, '%')
				</otherwise>
			</choose>
		</if>
			ORDER BY INSERT_DATE DESC
		<if test='recordCountPerPage != -1'>
			LIMIT #{firstIndex}, #{recordCountPerPage}
		</if>
	</select>
	
	<select id="getBoardListCnt" parameterType="map" resultType="String">
		<![CDATA[		
	       SELECT 
				COUNT(*)
			FROM girl_safe_board
	        WHERE 1=1
	     ]]> 
	    <if test="pushYN != null and pushYN != ''">
	    	AND PUSH_YN = #{pushYN}
	    </if>
	    <if test="boardInsertTimeS != null and boardInsertTimeS != ''">
	    <![CDATA[
	    	AND INSERT_DATE >= #{boardInsertTimeS}
	    ]]> 
	    </if>
	    <if test="boardInsertTimeE != null and boardInsertTimeE != ''">
	    <![CDATA[
	    	AND INSERT_DATE <= #{boardInsertTimeE}
	    ]]> 
	    </if>
		<if test="searchType != null and searchType != ''">
			<choose>
				<when test="searchType == 'title'">
				AND TITLE LIKE CONCAT('%', #{totSearch}, '%')
				</when> 
				<when test="searchType == 'cont'">
				AND CONTENT LIKE CONCAT('%', #{totSearch}, '%')
				</when>
				<otherwise>
				AND TITLE LIKE CONCAT('%', #{totSearch}, '%')
				</otherwise>
			</choose>
		</if>
   
	</select>
	
	<select id="getBoardOne" parameterType="map" resultType="HashMap">
		<![CDATA[		
	       SELECT 
	       		NO as no,
				TITLE as title,
				CONTENT as content,
				PUSH_YN as pushYN,
				COUNT as count,
				date_format(INSERT_DATE,'%Y-%m-%d') as insertDate,
				date_format(UPDATE_DATE,'%Y-%m-%d') as updateDate
	        FROM girl_safe_board 
	        WHERE 1=1
	        AND NO = #{no}
	    ]]> 
	</select>
	
	<insert id="insertBoard" parameterType="map">
		INSERT INTO girl_safe_board
			(TITLE, CONTENT, PUSH_YN, COUNT, INSERT_DATE, UPDATE_DATE)
		VALUES
			(#{title},
			#{content},
			'N',
			0,
			NOW(),
			NOW())
	</insert>
	
	<update id="updateBoard" parameterType="map">
		UPDATE girl_safe_board
		SET 
		<if test = "title != null and title != ''">
			TITLE = #{title},
		</if>
		<if test = "content != null and content != ''">
			CONTENT = #{content},
		</if>
		<if test = "pushYN != null and pushYN != ''">
			PUSH_YN = #{pushYN},
		</if>
		<if test = "count != null and count != ''">
			COUNT = COUNT + 1,
		</if>
			UPDATE_DATE = NOW()
		WHERE NO = #{no}
	</update>
</mapper>